<!DOCTYPE html>
<html>
<head>
<title>The Document Querying Throwdown</title>
<link href='http://fonts.googleapis.com/css?family=Permanent+Marker' rel='stylesheet' type='text/css'>
<style type="text/css">

body {
  margin: auto;
  font: 13px/1.5 Helvetica, Arial, 'Liberation Sans', FreeSans, sans-serif;
  background-color: #333;
  color: #ddd;
}

a:link, a:visited { font-style: italic; text-decoration: none; color: #66e; }
a:hover { border-bottom: 2px solid black ; }
.number { font-family: 'Permanent Marker', arial, serif; font-size: 4em; float: left; padding: 0 0 .5em 0; margin: 0; vertical-align: top; width: 1.3em}
.title { font-family: 'Permanent Marker', arial, serif; font-size: 2em; font-weight: bold; text-align: center; margin-top: 1.5em; margin-bottom: 1.5em; }
#intro { text-align: center;}
.step { width: 600px; margin: auto; margin-top: 1em;}
.desc { padding-top: 1.5em; min-height: 4.5em;}
.output {
  font-family: 'lucida console', monaco, 'andale mono', 'bitstream vera sans mono', consolas, monospace;
  border: 3px solid #666;
  -moz-border-radius: 4px;
  -webkit-border-radius: 4px;
  border-radius: 4px;
  padding: .5em;
  margin: .5em;
  color: #ccc;
  background-color: #333;
/*  white-space: pre;*/
  font-size: .9em;
  width:600px;
  word-wrap: break-word;
}
#survey, #intro, #results, #holdonasec {
  display: none;
}
body > div {
  font-size: 1.2em; width: 600px; margin: auto; 
}


body > div#results {
  width: 800px;
}

.username { font-weight: bold; }
pre {
  font-family: 'lucida console', monaco, 'andale mono', 'bitstream vera sans mono', consolas, monospace;
  padding: 1em;
  font-size: .8em;
  background-color: #333;
  color: #aaa;
  border-radius: .5em, .5em, .5em, .5em;
  -moz-border-radius: .5em;
  -webkit-border-radius: .5em;
  border: .5em solid #666;
}
.desc li {
  margin-left: 8em;
  font-family: 'lucida console', monaco, 'andale mono', 'bitstream vera sans mono', consolas, monospace;
}

.desc li {
  color: #666;
  cursor: pointer;
}

.desc li.booyah {
  color: #060;
}

#viz {
  background-color: #333;
  color: #aaa;
  border-radius: .5em, .5em, .5em, .5em;
  -moz-border-radius: .5em;
  -webkit-border-radius: .5em;
  width: 640;
  height: 320;
}

#results .header {
  text-align: center;
  font-size: 90%;
  margin: 1em 0 .2em 0;
}

.vizCont {
  font-family: 'Permanent Marker', arial, serif; 
}

</style>
<script type="text/javascript" src="https://blobastor.us/api.js"></script>
</head>
<body>
<div class="title">
  The Document Querying Throwdown
</div>

<div id="intro">
  <p>
    This website attempts to figure out what the most awesome querying language is for JSON documents.
    It does this by asking you a series of questions.
  </p>
  <p>
    <a href="#">Sign in with your twitter account</a> to get started.
  </p>
  <p>
    (I <b>will NOT</b> write to your twitter stream.  Twitter auth is so you can't vote twice.)
  </p>
</div>

<div id="holdonasec">
<div class="intro">
  HI <span class="username"></span>!  PLEASE WAIT, PROCESSING!!
</div>
</div>

<div id="survey">
<div class="intro">

<p>
  Hello <span class="username"></span>. below you'll find seven
  questions.  A question is just a little language that describes a specific
  part of the JSON document below.  All you have to do is pick from the
  presented options which you feel is the <i>best</i> looking way
  to represent the question in a computer language.
</p>
<p>
  Here's the JSON document (<a href="http://goessner.net/articles/JsonPath/">taken from goessner.net</a>):
</p>
</div>

<code><pre>
  { "store": {
    "book": [
      { "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      { "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      },
      { "category": "fiction",
        "author": "Herman Melville",
        "title": "Moby Dick",
        "isbn": "0-553-21311-3",
        "price": 8.99
      },
      { "category": "fiction",
        "author": "J. R. R. Tolkien",
        "title": "The Lord of the Rings",
        "isbn": "0-395-19395-8",
        "price": 22.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  }
}
</pre></code>

<div class="step">
  <div class="number">1.</div>
  <div class="desc">
    <b>The authors of all books in the store</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $.store.book[*].author
      <li l="jsonselect"> .store .book .author
      <li l="javascript"> var a = []; for (var i = 0; i < x.store.book.length; i++) a.push(x.store.book[i].author;
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">2.</div>
  <div class="desc">
    <b>All authors</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $..author
      <li l="jsonselect"> .author
      <li l="javascript"> var a = []; for (var i = 0; i < x.store.book.length; i++) a.push(x.store.book[i].author);
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">3.</div>
  <div class="desc">
    <b>All things in store, which are some books and a red bicycle.</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $.store.*
      <li l="jsonselect"> .store > *
      <li l="javascript"> 
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">4.</div>
  <div class="desc">
    <b>The price of everything in the store</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $.store..price
      <li l="jsonselect"> .store .price
      <li l="javascript"> 
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">5.</div>
  <div class="desc">
    <b>The third book</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $..book[2]
      <li l="jsonselect"> .book > :nth-child(3)
      <li l="javascript"> obj.store.book[2];
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">6.</div>
  <div class="desc">
    <b>the last book.</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $..book[-1:]
      <li l="jsonselect"> .book > :last-child
      <li l="javascript"> obj.store.book[obj.store.book.length - 1];
    </ol>
  </div>
</div>

<div class="step">
  <div class="number">7.</div>
  <div class="desc">
    <b>All books less than 10 US dollars</b>
    <ol>
      <li l="rql">
      <li l="jsonpath"> $..book[?(@.price<10)]
      <li l="jsonselect"> .book:has(.price:expr(x < 10))
    </ol>
  </div>
</div>
</div>

<div id="results">
<div class="header">
<span class="verb">Loading</span> results...  <span class="num"></span> surveys taken...  Showing <span class="got">0</span>/<span class="max">..</span> data points.
</div>
<div class="vizCont">
<div style="float: right;">JSONPath</div><div>JavaScript</div>
<div id="viz"></div>
<div style="float: right;">RQL</div><div>JSONSelect</div>
</div>
</div>

</body>
<script src="jquery-1.6.1.min.js"></script>
<script src="raphael-min.js"></script>
<script>

$BS = Blobastorus;

$BS.setScope("TDQT");

var g_username = undefined;

$BS.getUser(function(username, error) {
  if (!username) {
    $("#intro").fadeIn(700);
  } else {
    g_username = username;
    $(".username").text(username);
    $("#holdonasec").fadeIn(700, function() {
      $BS.getBlob(function(blob, error) {
        if (blob) {
          loadResults();
        } else {
          $("#holdonasec").fadeOut(200, function() {
            $("#survey").fadeIn(700);
            surveySetup();
          });
        }
      });
    });
  }
});


// :random awesome for jquery, cred:
// http://blog.mastykarz.nl/jquery-random-filter/
jQuery.jQueryRandom = 0;
jQuery.extend(jQuery.expr[":"],
{
    random: function(a, i, m, r) {
        if (i == 0) {
            jQuery.jQueryRandom = Math.floor(Math.random() * r.length);
        };
        return i == jQuery.jQueryRandom;
    }
});

function surveySetup(iterations) {
  // jumble everything!
  $("#survey .step").each(function() {
    var newKids = [];
    while (newKids.length < 3) {
      var n = $(this).find("li:random");
      n.detach();
      newKids.push(n);                              
    }
    $(this).find("ol").append(newKids[0]).append(newKids[1]).append(newKids[2]);
  });
   $("#survey li").click(function()  {
    $(this).parent().find("li").removeClass("booyah");
    $(this).addClass("booyah");
    var node = this;
    setTimeout(function() {
      $(node).parent().parent().parent().hide("medium", doneCheck);
    }, 300);
  });
}

function doneCheck() {
  if ($("#survey .step:visible").length === 0) {
     // lets generate the results blob
     var ar = [];
     $("#survey .booyah").each(function (){
       ar.push($(this).attr("l"));
     });
     $BS.setBlob(ar, function() {
       $("#survey").fadeOut("slow", function() {
         $("#results").fadeIn("fast");
       });
     });
  }
}

$(document).ready(function() {
   // activate the signin link
   $("#intro a").click(function() {
      $BS.redirectUser("http://localhost:8100/index.html#fuckyeah");
   });
});

function loadResults() {
  var usars = [];
  var colors = ["#f00", "#0f0", "#00f", "#cc0", "#c0c", "#0cc"];

  var paper = Raphael("viz", 800, 400);

  var l = {
    "javascript": { x: 0, y: 0 },
    "jsonselect": { x: 0, y: 400 },
    "jsonpath":   { x: 800, y: 0 },
    "rql":        { x: 800, y: 400 }                              
  };

  function loadOneUser() {
    if (usars.length === 0) return;
    var u = usars.shift();

    setTimeout(function() {
        var ar = u;                            
        console.log(ar);
//    $BS.getBlob(u, function(ar, error) {
        var x = 0, y = 0;
        for (var i = 0; i < ar.length; i++) {
            console.log(ar[i]);
            x += l[ar[i]].x;
            y += l[ar[i]].y;
        }
        x /= ar.length;
        y /= ar.length;
        // randomize positioning a little bit
        x += (Math.random() * (800 / 7)) - (800 / 14);
        y += (Math.random() * (400 / 7)) - (400 / 14);
        if (x>897) x = 797;
        if (y>447) y = 447;
        var circle = paper.circle(x, y, 4 + (4 * Math.random() - 2));
        var color = colors[Math.floor(Math.random() * colors.length)];
        circle.attr("fill", "#f00");
        circle.attr("stroke", "#fff");
        $("#results .got").text(parseInt($("#results .got").text(),10)+1);             loadOneUser();
    }, 0);
  }  

  $("#holdonasec").fadeIn(100, function() {
    // XXX: it's a bug that scope is require here.  didn't we setscope?
    $BS.listUsers("TDQT", function(users) {
      $("#results .num").text(users.length);      
      var num = users.length > 30 ? 30 : users.length;
      $("#results .max").text(num);
      $("#holdonasec").hide();
      $("#results").fadeIn(700);
/*      while (num-- > 0) {
        usars.push(users.splice(Math.floor(Math.random() * users.length)));
      }
*/
      var o = ["javascript", "jsonselect", "jsonpath", "rql"];
      for (var i = 0; i < 7000; i++) {
        var a = [];
        for (var j = 0; j < 7; j++) {
          a.push(o[Math.floor(Math.random() * o.length)]);
        }                            
        usars.push(a);

      }
      loadOneUser();
    });
  });
}
</script>
</html>
